let Web3 = require('web3');
let web3;

if (typeof web3 !== 'undefined') {
    web3 = new Web3(web3.currentProvider);
} else {
    // set the provider you want from Web3.providers
    web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}

let from = web3.eth.accounts[0];


//编译合约
let transferCompiled =[{"constant":false,"inputs":[],"name":"Adduser","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"buildChannel","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"getAmount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"t","type":"uint256"}],"name":"getAvailable","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"getChannel","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"getCurrentNum","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"getDonator","outputs":[{"name":"amount","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"getUserInfo","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_index","type":"uint256"}],"name":"Index","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_amount","type":"uint256"}],"name":"IO","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_IsConsumer","type":"uint256"}],"name":"hadPaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_channelIndex","type":"uint256"}],"name":"channelIndex","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_finish","type":"uint256"}],"name":"buildChan","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_left","type":"uint256"}],"name":"canLeave","type":"event"},{"anonymous":false,"inputs":[],"name":"addSuccess","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_amount","type":"uint256"},{"indexed":false,"name":"_channelIndex","type":"uint256"},{"indexed":false,"name":"_IsConsumer","type":"uint256"}],"name":"InfoEvent","type":"event"},{"constant":false,"inputs":[],"name":"left","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"pay","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"num","type":"uint256"}],"name":"setChannel","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"input","type":"uint256"},{"name":"output","type":"uint256"}],"name":"setIO","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":true,"stateMutability":"payable","type":"constructor"},{"constant":true,"inputs":[],"name":"getIndex","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"userlist","outputs":[{"name":"addr","type":"address"},{"name":"IsConsumer","type":"bool"},{"name":"hadPaid","type":"bool"},{"name":"amount","type":"uint256"},{"name":"channelIndex","type":"uint256"},{"name":"isInUsed","type":"bool"},{"name":"isVaild","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"}];
//let abiDefinition = transferCompiled["info"]["abiDefinition"];
let transferContract = web3.eth.contract(transferCompiled);

//2. 部署合约

//2.1 获取合约的代码，部署时传递的就是合约编译后的二进制码
let deployCode = "0x60806040526001600055600a60015560036020604051908101604052806001151581525090806001815401808255809150509060018203906000526020600020016000909192909190915060008201518160000160006101000a81548160ff0219169083151502179055505050506117218061007c6000396000f3006080604052600436106100d0576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631140d71e146100d5578063148dfbd7146100ec57806316e64048146101195780631b9265b81461013057806346533c361461013a5780635d8d1585146101715780637e9849ee1461018857806381045ead146101b357806390392a7a146101de578063930eee7b146101f55780639f09355214610220578063bf835cba14610261578063c444e19e1461028c578063d321fe2914610349575b600080fd5b3480156100e157600080fd5b506100ea610374565b005b3480156100f857600080fd5b5061011760048036038101908080359060200190929190505050610648565b005b34801561012557600080fd5b5061012e610803565b005b610138610cf0565b005b34801561014657600080fd5b5061016f60048036038101908080359060200190929190803590602001909291905050506110cc565b005b34801561017d57600080fd5b5061018661135b565b005b34801561019457600080fd5b5061019d61148e565b6040518082815260200191505060405180910390f35b3480156101bf57600080fd5b506101c8611497565b6040518082815260200191505060405180910390f35b3480156101ea57600080fd5b506101f36114a1565b005b34801561020157600080fd5b5061020a611554565b6040518082815260200191505060405180910390f35b34801561022c57600080fd5b5061024b60048036038101908080359060200190929190505050611582565b6040518082815260200191505060405180910390f35b34801561026d57600080fd5b506102766115c6565b6040518082815260200191505060405180910390f35b34801561029857600080fd5b506102cd600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611610565b604051808873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018715151515815260200186151515158152602001858152602001848152602001831515151581526020018215151515815260200197505050505050505060405180910390f35b34801561035557600080fd5b5061035e6116a6565b6040518082815260200191505060405180910390f35b6000806000809250339150600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160019054906101000a900460ff1615156106135760018160030160016101000a81548160ff02191690831515021790555060008160000160146101000a81548160ff02191690831515021790555060018160000160156101000a81548160ff021916908315150217905550600081600101819055506064816002018190555060008160030160006101000a81548160ff021916908315150217905550818160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000820160149054906101000a900460ff168160000160146101000a81548160ff0219169083151502179055506000820160159054906101000a900460ff168160000160156101000a81548160ff02191690831515021790555060018201548160010155600282015481600201556003820160009054906101000a900460ff168160030160006101000a81548160ff0219169083151502179055506003820160019054906101000a900460ff168160030160016101000a81548160ff0219169083151502179055509050505b600192507f4f849ef9102744ee017d538f6311a21f4f56ae283dfba64241d668d69e660e2c60405160405180910390a1505050565b6000339050600460008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160009054906101000a900460ff16156106af57600360028190555061078f565b60006003838154811015156106c057fe5b9060005260206000200160000160006101000a81548160ff02191690831515021790555081600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201819055506001600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160006101000a81548160ff02191690831515021790555060016002819055505b7fbc4bc9c81963cfbf61c958448f1c4b4b382b0a997a2fb0d1fd153818bb2aa27b6002546040518082815260200191505060405180910390a17f8b5cdf1866b6191755715ce47b505e314ab06a09c875d145ec5ee3ff865680cc826040518082815260200191505060405180910390a15050565b600080600091503390506000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160006101000a81548160ff0219169083151502179055506000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160156101000a81548160ff021916908315150217905550600460008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201549150600160038381548110151561091957fe5b9060005260206000200160000160006101000a81548160ff021916908315150217905550600460008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff161515610cb157600560e0604051908101604052808373ffffffffffffffffffffffffffffffffffffffff168152602001600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff1615158152602001600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160159054906101000a900460ff1615158152602001600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101548152602001600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201548152602001600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160009054906101000a900460ff1615158152602001600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060030160019054906101000a900460ff1615158152509080600181540180825580915050906001820390600052602060002090600402016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160000160146101000a81548160ff02191690831515021790555060408201518160000160156101000a81548160ff021916908315150217905550606082015181600101556080820151816002015560a08201518160030160006101000a81548160ff02191690831515021790555060c08201518160030160016101000a81548160ff0219169083151502179055505050505b600191507ff18d55622d6245d3af1f32f6c6da7c1872c30bf6efa733bd1cfe7beef1a98900826040518082815260200191505060405180910390a15050565b600080600080600060019450339350349250600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206001015483141515610d5257600080fd5b6001600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160156101000a81548160ff02191690831515021790555082600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101600082825403925050819055506000600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff021916908315150217905550600090505b600580549050811015610fbb57600581815481101515610e7957fe5b9060005260206000209060040201600101549150600082111580610eb5575060003073ffffffffffffffffffffffffffffffffffffffff163111155b15610ebf57610fbb565b813073ffffffffffffffffffffffffffffffffffffffff16311015610ef9573073ffffffffffffffffffffffffffffffffffffffff163191505b600581815481101515610f0857fe5b906000526020600020906004020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc839081150290604051600060405180830381858888f19350505050158015610f7f573d6000803e3d6000fd5b5081600582815481101515610f9057fe5b9060005260206000209060040201600101600082825403925050819055508080600101915050610e5d565b600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160159054906101000a900460ff161561101557600094505b7fcd71ac9330a96f4b839f848ee9f5107626edc35fd7933e48671cfc5f3c9d60fd856040518082815260200191505060405180910390a17f2dfa8ec119168ce5884b1dae0a7e951cab26591c1d8ba159719e13944a704de6600460008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101546040518082815260200191505060405180910390a15050505050565b6000339050828211156111dd576001600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff021916908315150217905550828203600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101819055506000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff0219169083151502179055506112dd565b6000600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff021916908315150217905550818303600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101819055506001600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160146101000a81548160ff0219169083151502179055505b7f2dfa8ec119168ce5884b1dae0a7e951cab26591c1d8ba159719e13944a704de6600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600101546040518082815260200191505060405180910390a1505050565b60008033915060009050600460008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000160149054906101000a900460ff16156113bf57600190505b7f67d41acdd167a15160aa161b49a8271d412cb3349a71a6d44aaeec56d628eea4600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010154600460008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600201548360405180848152602001838152602001828152602001935050505060405180910390a15050565b60008054905090565b6000600254905090565b600080905060036020604051908101604052806001151581525090806001815401808255809150509060018203906000526020600020016000909192909190915060008201518160000160006101000a81548160ff021916908315150217905550505050600190507f4010a00d83ba341407bb0e5034fdd8d2892317b29625b94414fa142e4a70ed92816040518082815260200191505060405180910390a1600080815480929190600101919050555050565b6000803390506005600181548110151561156a57fe5b90600052602060002090600402016001015491505090565b600060038281548110151561159357fe5b9060005260206000200160000160009054906101000a900460ff16156115bc57600190506115c1565b600090505b919050565b6000600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020154905090565b60046020528060005260406000206000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060000160149054906101000a900460ff16908060000160159054906101000a900460ff16908060010154908060020154908060030160009054906101000a900460ff16908060030160019054906101000a900460ff16905087565b600080339050600460008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010154915050905600a165627a7a72305820bb6873dea07dcc8997fd7ded532c49512595347d478d9584739bd4d908a4e4920029";

let deployeAddr = web3.eth.accounts[0];   
console.log(deployeAddr);
//2.3 异步方式，部署合约

//警告，你不应该每次都部署合约，这里只是为了提供一个可以完全跑通的例子！！！
transferContract.new({
    data: deployCode,
    from: deployeAddr,
    gas:  2000000
}, function(err, myContract) {
    if (!err) {
        // 注意：这个回调会触发两次
        //一次是合约的交易哈希属性完成
        //另一次是在某个地址上完成部署

        // 通过判断是否有地址，来确认是第一次调用，还是第二次调用。
        if (!myContract.address) {
            console.log("contract deploy transaction hash: " + myContract.transactionHash) //部署合约的交易哈希值
            // 合约发布成功后，才能调用后续的方法
        } else {
            console.log("contract deploy address: " + myContract.address) // 合约的部署地址

          //  console.log("Current balance: " + myContract.getBanlance());
            //使用transaction方式调用，写入到区块链上
            // myContract.deposit.sendTransaction({
            //     from: deployeAddr,
            //     value: 100,
            //     gas: 1000000
            // }, function(err, result){
            //   console.log("Deposit status: " + err + " result: " + result);
 //             console.log("After deposit balance: " + myContract.getBanlance());


            // });
        }
    }
    else
        console.log(err);
});